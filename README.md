# Keithley6517B-MQTT

## Overview

This MQTT client enables remote control and monitoring of the Keithley 6517B Electrometer. By leveraging MQTT, a lightweight messaging protocol, this client facilitates seamless integration of the Keithley 6517B into IoT systems, allowing users to automate measurements and monitor data remotely in real-time.

The client is built on top of the Pymeasure library, ensuring robust communication with the Keithley 6517B via standard SCPI commands. This project is ideal for researchers, engineers, and developers who need to interface the electrometer with other devices or cloud services.

## Dependencies

- Pymeasure [https://pymeasure.readthedocs.io/en/latest/index.html]: A Python library for scientific measurements, including support for Keithley 6517B.

## Configuration

The MQTT client is configurable through a YAML configuration file, where you can specify various settings to tailor the client's behavior to your needs.

### Example Configuration File

```yaml
    client_id: "keithley6517b-8744a469-ea32-4f93-ae69-b6f608e51157"
    topic_base: "keithley6517b"
    device_name: "Keithley6517B"
    mqtt_broker: "localhost"
    mqtt_port: 1883
```

### Configuration Options

- client_id: Unique client ID for communication with the MQTT broker (could be generated by `utils/generate_client_id.py`)
- topic_base: The base topic used for all MQTT messages. This should be defined in the configuration file.
- device_name: The name of the Keithley6517B device. Default is Keithley6517B, but this can be customized, especially useful when managing multiple devices.
- mqtt_broker: The address of the MQTT broker to connect to. Default: "localhost".
- mqtt_port: The port number on which the MQTT broker is listening. Default: 1883.
- keep_alive: The keep-alive time in seconds for maintaining the connection to the broker. Default: 60.

## MQTT Message Structure

The client communicates using MQTT messages structured as `<topic_base>/<action>/<device_name>/<command>`.

List of supported messages:

- Status Messages
  - `<topic_base>/connected/<device_name>`
- Error Messages
  - `<topic_base>/error/disconnected/<device_name>`
- Command Messages
  - `<topic_base>/cmnd/<device_name>/apply_voltage`
  - `<topic_base>/cmnd/<device_name>/auto_range_source`
  - `<topic_base>/cmnd/<device_name>/current`
  - `<topic_base>/cmnd/<device_name>/current_range`
  - `<topic_base>/cmnd/<device_name>/disable_source`
  - `<topic_base>/cmnd/<device_name>/enable_source`
  - `<topic_base>/cmnd/<device_name>/config_measure_current`
  - `<topic_base>/cmnd/<device_name>/reset`
  - `<topic_base>/cmnd/<device_name>/shutdown`
  - `<topic_base>/cmnd/<device_name>/source_enabled`
  - `<topic_base>/cmnd/<device_name>/voltage_range`
- Response Messages
  - `<topic_base>/response/<device_name>/current`
  - `<topic_base>/response/<device_name>/current_range`
  - `<topic_base>/response/<device_name>/voltage_range`
  - `<topic_base>/response/<device_name>/source_enabled`

### Status Messages

Status messages are sent by the client to provide information about the connection status of the device.

#### `<topic_base>/connected/<device_name>`

- **Description**: Identifies the connected Keithley 6517B device. Subscribing to this topic allows monitoring of the device's connection status.
- **Message**: A retained message (QOS = 1) is published on this topic when the device is connected.

### Error Messages

Error messages notify about issues such as disconnection.

#### `<topic_base>/error/disconnected/<device_name>`

- **Description**: Notifies when the Keithley 6517B device is disconnected.

### Command Messages

These are the commands subscribed by the client to control the internal state of the Keithley6517B device.

- **Topic**: `<topic_base>/cmnd/<device_name>/<command>`
- **Payload**: The payload typically includes a `"value"` field that sets the new value or retrieves the current value.
- **Response**: A corresponding response message or an error message is published based on the outcome of the command. The original command's payload is included for tracking.

#### `<topic_base>/cmnd/<device_name>/apply_voltage`

- **Description**: Configures the Keithley 6517B to apply a source voltage. It uses auto-ranging unless a specific voltage range is provided.
- **Payload**:
  - `"voltage_range"`: Specify the desired voltage range or set to null for auto range.

Example Payload:

> ```json
>   {
>     "voltage_range": <value>
>   }
> ```

 For example, `{"voltage_range": 10}` to set a 10V range, or `{"voltage_range": null}` for auto-ranging.

- **Response Message**:
  - `<topic_base>/response/<device_name>/voltage_range`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/auto_range_source`

- **Description**: Enables auto-ranging for the source voltage output.
- **Payload**:
  - No payload is required for this command.
- **Response Message**:
  - `<topic_base>/response/<device_name>/voltage_range`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/current`

- **Description**: Reads the current in Amps, if configured for this reading.
- **Payload**:
  - No payload is required for this command. It acts as a getter to retrieve the current.
- **Response Message**:
  - `<topic_base>/response/<device_name>/current`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/current_range`

- **Description**: Sets the measurement current range in Amps. The value can range between -20 and +20 mA. Setting this property disables auto-ranging.
- **Payload**:
  - `"current_range"`: The desired current range in Amps, within the range of -20 to +20 mA.

  ```json
  {
    "current_range": <float>
  }

- **Response Message**:
  - `<topic_base>/response/<device_name>/current_range`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/disable_source`

- **Description**: Disables the source of current or voltage depending on the configuration of the instrument.
- **Payload**:
  - No payload is required for this command.
- **Response Message**:
  - `<topic_base>/response/<device_name>/source_enabled`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/enable_source`

- **Description**: Enables the source of current or voltage depending on the configuration of the instrument.
- **Payload**:
  - No payload is required for this command.
- **Response Message**:
  - `<topic_base>/response/<device_name>/source_enabled`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/config_measure_current`

- **Description**: Configures the Keithley 6517B to measure current.
- **Payload**:
  - nplc: The number of power line cycles (NPLC) to use for the measurement. The value can range between 0.01 and 10.
  - current: Upper limit of current in Amps, from -21 mA to 21 mA.
  - auto_range: Enable or disable auto-ranging for the current measurement.

> Example Payload:
>
> ```json
> {
>   "nplc": 1,
>   "current": 0.01,
>   "auto_range": true
> }
> ```

- **Response Message**:
  - `<topic_base>/response/<device_name>/current_range`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/reset`

- **Description**: Resets the Keithley 6517B to its default settings.
- **Payload**:
  - No payload is required for this command.
- **Response Message**:
  - `<topic_base>/connected/<device_name>`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/shutdown`

- **Description**: Ensures that the current or voltage is turned to zero and disables the output.
- **Payload**:
  - No payload is required for this command.
- **Response Message**:
  - `<topic_base>/response/<device_name>/source_enabled`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

#### `<topic_base>/cmnd/<device_name>/source_enabled`

- **Description**: Checks if the source is enabled or disabled.
- **Payload**:
  - No payload is required for this command.
- **Response Message**:
  - `<topic_base>/response/<device_name>/source_enabled`
- **Error Message**:
  - `<topic_base>/error/disconnected/<device_name>`

### Response Messages

These messages are sent by the client in response to command messages.

#### `<topic_base>/response/<device_name>/current`

- **Description**: Returns the current in Amps, if configured for this reading.
- **Payload**:
  - `"value": <float>` - The current in Amps.
  - `"sender_payload": [<corresponding command's message payload>]` - The original command's payload for tracking.

> Example Payload:
>
> ```json
> {
>   "value": 3.2e-10,
>   "sender_payload": {}
> }
> ```

#### `<topic_base>/response/<device_name>/current_range`

- **Description**: Returns the set current range in Amps.
- **Payload**:
  - `"value": <float>` - The current range in Amps.
  - `"sender_payload": [<corresponding command's message payload>]` - The original command's payload for tracking.

> Example Payload:
>
> ```json
> {
>   "value": 0.01,
>   "sender_payload": {"current_range": 0.01}
> }
> ```

#### `<topic_base>/response/<device_name>/voltage_range`

- **Description**: Returns the voltage range in Volts.
- **Payload**:
  - `"value": <float>` - The voltage range in Volts.
  - `"sender_payload": [<corresponding command's message payload>]` - The original command's payload for tracking.

> Example Payload:
>
> ```json
> {
>   "value": 10.0,
>   "sender_payload": {}
> }
> ```

#### `<topic_base>/response/<device_name>/source_enabled`

- **Description**: Returns the status of the source (enabled/disabled).
- **Payload**:
  - `"value": <bool>` - The source status.
  - `"sender_payload": [<corresponding command's message payload>]` - The original command's payload for tracking.

> Example Payload:
>
> ```json
> {
>   "value": true,
>   "sender_payload": {}
> }
> ```
